{
    "contents" : "require(openxlsx, quietly = TRUE)\nrequire(dplyr, quietly = TRUE)\nrequire(ggplot2, quietly = TRUE)\nrequire(tidyr, quietly = TRUE)\n#require(stringr, quietly = TRUE)\nrequire(zoo, quietly = TRUE)\n\nxls.file<-\"../CORES/consumos-pp.xlsx\"\n\nif(!file.exists(\"consumos-pp.xlsx\")) \n      download.file(\"http://www.cores.es/sites/default/files/archivos/estadisticas/consumos-pp.xlsx\", \n      xls.file, mode = \"wb\")\n\ndftemp<-read.xlsx(xls.file, sheet=\"GLPs\", startRow = 6)\ndftemp<-filter(dftemp, Mes != \"\")\nnames(dftemp)<-c(\"anyo\", \"mes\", \"GLP.envasado\", \"GLP.granel\", \"GLP.automocion\", \"GLP.otros\", \"GLP.total\")\n\npp.df<-dftemp\n\ndftemp<-read.xlsx(xls.file, sheet = \"Gasolinas\", startRow = 6, cols = 1:11)\ndftemp<-filter(dftemp, Mes != \"\")\nnames(dftemp)<- c('anyo','mes','GSNA.GS97','GSNA.GS95','GSNA.GS98','GSNA.bioetanol','GSNA.mezcla',\n                  'GSNA.auto','GSNA.aviacion','GSNA.otras','GSNA.total')\n\npp.df<-merge(pp.df, dftemp)\n\ndftemp<-read.xlsx(xls.file, sheet = \"Querosenos\", startRow = 6, cols = 1:5)\ndftemp<-filter(dftemp, Mes != \"\")\nnames(dftemp)<- c('anyo','mes','KERO.aviacion','KERO.otros','KERO.total')\n\npp.df<-merge(pp.df, dftemp)\n\ndftemp<-read.xlsx(xls.file, sheet = \"Gasoleos\", startRow = 6, cols = 1:10)\ndftemp<-filter(dftemp, Mes != \"\")\nnames(dftemp)<- c('anyo','mes','GOIL.goa','GOIL.biodiesel','GOIL.biomezcla',\n                  'GOIL.auto','GOIL.gob','GOIL.goc','GOIL.otros','GOIL.total')\n\npp.df<-merge(pp.df, dftemp)\n\ndftemp<-read.xlsx(xls.file, sheet = \"Fueloleos\", startRow = 6, cols = 1:7)\ndftemp<-filter(dftemp, Mes != \"\")\nnames(dftemp)<- c('anyo','mes','FUEL.fo1','FUEL.fo2','FUEL.fobia',\n                  'FUEL.otros','FUEL.total')\n\npp.df<-merge(pp.df, dftemp)\n\ndftemp<-read.xlsx(xls.file, sheet = \"Otros Productos\", startRow = 6, cols = 1:7)\ndftemp<-filter(dftemp, Mes != \"\")\nnames(dftemp)<- c('anyo','mes','OTROS.lubricantes','OTROS.asfalto',\n                  'OTROS.coque','OTROS.otros','OTROS.total')\n\npp.df<-merge(pp.df, dftemp)\n\npp.df<- pp.df %>% \n      mutate_each(funs(ch2num = ifelse(is.na(.), NA, as.numeric(.))), -c(1:2)) %>%\n      filter(mes != \"total\") %>%\n      mutate(fecha = as.yearmon(paste(mes, anyo))) %>%\n      arrange(fecha) %>%\n      select(fecha, everything()) %>%\n      mutate_each(funs(consumo2kt=ifelse(is.na(.), NA, ./1000)), -c(1:3))\n\nsaveRDS(pp.df, file = 'data/consumos-pp.RDS') \n\n###########################################################################\n\nrequire(dplyr, quietly = TRUE)\nrequire(ggplot2, quietly = TRUE)\nrequire(tidyr, quietly = TRUE)\nrequire(zoo, quietly = TRUE)\n\npp.df<-readRDS('data/consumos-pp.RDS')\n\n# ppg.df<-pp.df %>%\n#      gather(key=gen.par, consumo.kt, -c(1:3)) %>%\n#      separate(gen.par, into = c(\"familia\", \"producto\"), sep = \"\\\\.\") %>%\n#      select(-anyo, -mes)\n\n\nzpp<-pp.df %>% select(fecha, -anyo, -mes, one_of(names(pp.df)[sample(4:38,4)]))\n                  \nzpp<-zoo(x = select(zpp, -fecha), order.by=zpp$fecha)\n\nnor<-sapply(window(zpp, start = start(zpp), end = start(zpp)+11/12),function(x) ifelse(is.na(100/mean(x)), 1, 100/mean(x)))\n\nbreaks.zpp = start(zpp)+seq.int(0,(end(zpp)-start(zpp))*12, length.out = 12)/12\n\nautoplot(zpp,na.rm = TRUE) + facet_free() + scale_x_yearmon(breaks=breaks.zpp, format = \"%b %Y\") + geom_smooth(na.rm = TRUE)\n\nz<-zoo(x=pp.df$GSNA.auto, order.by = pp.df$fecha)\nz.stl<-stl(z, s.window = 7, robust = TRUE)\nplot(z.stl)\nzt<-window(z, end = end(z)-1)\nz.stl<-forecast(stlf(zt, s.window = 7, robust = TRUE))\nz.gg<-funggcast(z, z.stl)\n\nxlim.Sel<-c(as.yearmon(paste0(2006,\"-01-01\")), as.yearmon(paste0(2018,\"-01-01\")))\np1a<-ggplot(data=z.gg,aes(x=date,y=observed)) \np1a<-p1a+geom_line(col='red')\np1a<-p1a+geom_line(aes(y=fitted),col='blue')\np1a<-p1a+geom_line(aes(y=forecast))+geom_ribbon(aes(ymin=lo95,ymax=hi95),alpha=.25)\np1a<-p1a+scale_x_yearmon(limits=xlim.Sel)\np1a<-p1a+scale_y_continuous(name='Units of Y')\np1a<-p1a + ggtitle('STL Fit to Simulated Data\\n (black=forecast, blue=fitted, red=data, shadow=95% conf. interval)')\np1a\n",
    "created" : 1460398313460.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3728723744",
    "id" : "598C73A9",
    "lastKnownWriteTime" : 1459123112,
    "path" : "~/RProjects/CORES/ShinyCores2.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 12,
    "source_on_save" : false,
    "type" : "r_source"
}