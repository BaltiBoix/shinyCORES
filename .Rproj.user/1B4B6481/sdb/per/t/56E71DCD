{
    "contents" : "require(openxlsx, quietly = TRUE)\nrequire(dplyr, quietly = TRUE)\nrequire(zoo, quietly = TRUE)\nrequire(tidyr, quietly = TRUE)\n#require(lattice, quietly = TRUE)\n\n#download.file(\"http://www.cores.es/sites/default/files/archivos/estadisticas/consumos-pp-ccaa-provincias.xlsx\", \n#              \"consumos.xlsx\", mode = \"wb\")\ndf<-read.xlsx(\"../CORES/consumos.xlsx\", sheet=\"Consumos\", startRow = 6)\ndf<-filter(df, Año > 1997 & Año < 2020)\ndf<-select(df, -contains(\"bio\"))\nnames(df)<-c(\"Anyo\",\"Mes\",\"CCAA\",\"Provincia\",\"GS97\",\"GS95\",\"GS98\",\"GOA\",\"GOB\",\"GOC\",\"FOBIA\")\n\ndf<-mutate(df, fecha=as.yearmon(paste0(Mes,Anyo)))\ndf<-select(df, c(12,3:11))\ndf[is.na(df)] <- 0\ndf[,4:10]<-df[,4:10]/1000\nsaveRDS(df, file = 'consumos-pp-ccaa-provincias.RDS')\n\nCCAA.Sel<-c(\"Madrid\", \"Cataluña\", \"País Vasco\", \"Comunidad Valenciana\")\nProvincia.Sel<-\"Total\"\nxlim.Sel<-c(as.yearmon(paste0(2006,\"-01-01\")), as.yearmon(paste0(2016,\"-01-01\")))\nprod.Sel<-'GOA'\nnorm.Sel<-TRUE\nonefacet.Sel<-TRUE\n\niprod.Sel<-which(names(df) == prod.Sel)\n\nz<-df %>% \n      filter(CCAA %in% CCAA.Sel) %>% \n      filter(Provincia %in% Provincia.Sel) %>% \n      select(1:3, psel=iprod.Sel) %>%\n      mutate(CCAA.Prov=paste0(CCAA,'.',Provincia)) %>%\n      select(-CCAA, -Provincia) %>%\n      spread(key=CCAA.Prov, value=psel)\n\nif(NROW(z)>0) {\n      z<-zoo(x=z[,2:NCOL(z)], order.by = z[,1])\n\n      if(norm.Sel){\n            nor<-sapply(window(z, start = xlim.Sel[1], end = xlim.Sel[1]+11/12),function(x) 100/mean(x))\n            if(NCOL(z)>1) nor<-matrix(rep(nor,each=NROW(z)),ncol=NCOL(z))\n            z<-z * nor\n      }\n      \n      #zz<-rollmean(z,12, align = 'right')\n      #names(zz)<-paste0(names(zz),\"_mean\")\n      #z<-merge(z,zz)\n      \n      #xyplot(z, layout=c(1, ncol(z)), ylab='kt', main=CCAA.Sel, xlim=xlim.Sel, type=c(\"l\",\"g\", \"r\"))\n      if(onefacet.Sel){\n            g<-autoplot(z, na.rm = TRUE, facets = NULL)\n      }else{\n            g<-autoplot(z, na.rm = TRUE)\n            if(NCOL(z)>1) g<-g + facet_free()\n      }\n      g<-g + scale_x_yearmon(limits=xlim.Sel)\n      g<-g + geom_line(size=0.5, na.rm = TRUE)\n      g<-g + geom_smooth(se=F, size=1, na.rm = TRUE)\n      g<-g + xlab(\"Fecha\")\n      if(norm.Sel){ \n            g<-g + ylab(\"%\")\n      }else{\n            g<-g + ylab(\"kt/mes\")\n      }\n      g<-g + ggtitle(prod.Sel)\n      g<-g + theme(axis.text = element_text(size = 12),\n                   plot.title = element_text(size = 16, face='bold'),\n                   strip.text = element_text(size = 14, face='bold'),\n                   axis.title.x = element_text(size = 14),\n                   axis.title.y = element_text(size = 14),\n                   panel.border = element_rect(linetype = 'solid', color = 'red', fill = NA),\n                   strip.background = element_rect(linetype = 'solid', color = 'darkred', fill = 'gray'),\n                   panel.grid.major = element_line(colour = \"grey\"),\n                   panel.grid.minor = element_blank(),\n                   legend.position = 'bottom',\n                   legend.title=element_blank())\n      print(g)\n}",
    "created" : 1458908625730.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3911714040",
    "id" : "56E71DCD",
    "lastKnownWriteTime" : 1458988745,
    "path" : "~/RProjects/CORES/ShinyCores1.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "type" : "r_source"
}